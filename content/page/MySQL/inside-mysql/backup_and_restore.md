---
title: inside mysql 8 backup and restore
tags: 
- inside-mysql
categories: 
- MySQL
date: 2022-05-20
lastMod: 2022-05-20
---
## 8.6 snapshot backup

写时复制（COW, copy on write）: 当创建一个快照时，仅复制原始卷中数据的元数据，并不会有数据的物理操作，因此快照的创建过程非常快。当快照创建完成，原始卷上有写操作时，快照会跟踪原始卷块的改变，将要改变的数据在改变之前复制到快照预留的空间里。
对于快照的读取操作，如果读取的数据块时创建快照后没有修改过的，那么会将读操作直接重定向到原始卷上，如果要读取的是已经修改过的快，则将读取保存在快照中该块在原始卷上改变之前的数据。
因此，采用写时复制机制保证了读取快照时得到的数据与快照创建时一致。

用LVM快照备份InnoDB存储引擎表，只要把与InnoDB存储引擎相关的文件如共享表空间、独立表空间、重做日志文件等放在同一个逻辑卷中，然后对这个逻辑卷做快照备份即可。
在对InnoDB存储引擎文件做快照时，数据库无需关闭，即可在线备份。虽然此时数据库可能还有任务需要往磁盘上写数据，但这不会妨碍备份的正确性。因为其是事务安全的引擎，在下次恢复时，数据库会自动检查表空间中页的状态，并决定是否应用重做日志，恢复就好像数据库被意外重启了。
