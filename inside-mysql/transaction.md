# 7 Transaction

[MySQL 事务的隔离级别](https://developer.aliyun.com/article/743691)

InnoDB存储引擎中得事务完全符合ACID特性：

* 原子性（atomicity）
* 一致性（consistency）
* 隔离性（isolation）
* 持久性（durability）

## 7.1 认识事务

### 7.1.1 概述

事务时访问并更新数据库中各种数据项得一个程序执行单元。在事务中得操作，要么都做修改，要么都不做，这就是事务得目的。

**A（atomicity），原子性**。原子性指整个数据库事务是不可分割得工作单位。只有使事务中所有的数据库操作都执行成功，才算整个事务成功。事务中的任何SQL语句执行失败，必须回退到执行事务前的状态。
例如，用户从ATM机上取钱，不能用户钱未取到，但是钱已经扣了。

**C（consistency），一致性**。一致性指事务将数据库从一种状态转变为下一种一致的状态。在事务开始和事务结束以后，数据库的完整性约束没有被破坏。
例如，在表中有一个字段为姓名，为唯一约束，如果一个事务对其进行修改，但是在事务提交或发生回滚后，表中的姓名变得非唯一，则破坏了一致性。

**I（isolation），隔离性**。隔离性要求每个读写事务的对象对其他事务的操作对象能相互分离，即该事务提交前对其他事务都不可见，通常用锁实现。

**D（durability），持久性**。事务一旦提交，其结果就是永久性的。即使发生宕机等故障，数据库也能将数据恢复。持久性保证事务系统的高可靠性，而不是高可用性。

### 7.1.2 分类

从事务理论的角度来说，可以把事务分为以下几种类型：

* 扁平事务（Flat Transactions）
* 带有保存点的扁平事务（Flat Transactions with Savepoints）
* 链事务（Chained Transactions）
* 嵌套事务（Nested Transactions）
* 分布式事务（Distributed Transactions）

**扁平事务**是事务类型中最简单的一种，但在实际生产环境中，可能是使用最为频繁的事务。在扁平事务中，所有操作都处于同一层次，有BEGIN WORK开始，COMMIT WORK或ROLLBACK WORK结束，期间的操作是原子的，要么都执行，要么都回滚。

**带有保存点的扁平事务**，除了支持扁平事务支持的操作外，允许在事务执行过程中回滚到同一事务中较早的一个状态。**保存点**用来通知系统应该记住事务当前的状态，以前发生错误，事务能回到保存点当时的状态。

**链事务**可视为保存点模式的一种变种。带有保存点的扁平事务，保存点是易失的（volatile），而非持久的。意味着恢复时，事务需要从开始处重新执行。
链事务的思想是：在提交一个事务时，释放不需要的数据对象，将必要的处理上下文隐式地传给下一个要开始的事务。提交事务操作和开始下一个事务操作合并为一个原子操作。
链事务中的回滚仅限于当前事务，即只能恢复到最近一个的保存点。对于锁的处理，锁事务在执行COMMIT后即释放了当前事务所持有的锁。

**嵌套事务**是一个层次结构框架。由一个顶层事务（top-level transaction）控制着各个层次的事务。

**分布式事务**通常是在一个分布式环境下运行的扁平事务，因此需要根据数据所在位置访问网络中的不同节点。
例如用户在ATM机（A）从招商银行（B）转账到工商银行（C），A发出转账，B减去10000，C加上10000，A通知用户操作完成或者操作失败。A不能通过调用一台数据库就完成任务，每个节点的数据库执行的事务操作都是扁平的。对于分布式事务，同样需要满足ACID特性，要么都发生，要么都失效。

InnoDB对于嵌套事务，并不原生支持。
